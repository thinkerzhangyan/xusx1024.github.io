<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.jpg?v=5.1.1" />






<meta name="description" content="博观而约取，厚积而薄发。">
<meta property="og:type" content="website">
<meta property="og:title" content="行次">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="行次">
<meta property="og:description" content="博观而约取，厚积而薄发。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="行次">
<meta name="twitter:description" content="博观而约取，厚积而薄发。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>行次</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">行次</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/21/baseball-game/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/21/baseball-game/" itemprop="url">682. Baseball Game</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-21T00:00:00Z">
                2017-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Algorithm/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h4><p>You’re now a baseball game point recorder.</p>
<p>Given a list of strings, each string can be one of the 4 following types:</p>
<ol>
<li>Integer (one round’s score): Directly represents the number of points you get in this round.</li>
<li>“+” (one round’s score): Represents that the points you get in this round are the sum of the last two valid round’s points.</li>
<li>“D” (one round’s score): Represents that the points you get in this round are the doubled data of the last valid round’s points.</li>
<li>“C” (an operation, which isn’t a round’s score): Represents the last valid round’s points you get were invalid and should be removed.<br>Each round’s operation is permanent and could have an impact on the round before and the round after.</li>
</ol>
<p>You need to return the sum of the points you could get in all the rounds.</p>
<p>Example 1:</p>
<pre><code>Input: [&quot;5&quot;,&quot;2&quot;,&quot;C&quot;,&quot;D&quot;,&quot;+&quot;]
Output: 30
Explanation: 
Round 1: You could get 5 points. The sum is: 5.
Round 2: You could get 2 points. The sum is: 7.
Operation 1: The round 2&apos;s data was invalid. The sum is: 5.  
Round 3: You could get 10 points (the round 2&apos;s data has been removed). The sum is: 15.
Round 4: You could get 5 + 10 = 15 points. The sum is: 30.
</code></pre><p>Example 2:</p>
<pre><code>Input: [&quot;5&quot;,&quot;-2&quot;,&quot;4&quot;,&quot;C&quot;,&quot;D&quot;,&quot;9&quot;,&quot;+&quot;,&quot;+&quot;]
Output: 27
Explanation: 
Round 1: You could get 5 points. The sum is: 5.
Round 2: You could get -2 points. The sum is: 3.
Round 3: You could get 4 points. The sum is: 7.
Operation 1: The round 3&apos;s data is invalid. The sum is: 3.  
Round 4: You could get -4 points (the round 3&apos;s data has been removed). The sum is: -1.
Round 5: You could get 9 points. The sum is: 8.
Round 6: You could get -4 + 9 = 5 points. The sum is 13.
Round 7: You could get 9 + 5 = 14 points. The sum is 27.
</code></pre><p>Note:</p>
<ul>
<li>The size of the input list will be between 1 and 1000.</li>
<li>Every integer represented in the list will be between -30000 and 30000.</li>
</ul>
<h4 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h4><h5 id="7ms"><a href="#7ms" class="headerlink" title="7ms"></a>7ms</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"> public int calPointsBestTime(String[] ops) &#123;</div><div class="line">  int ans = 0;</div><div class="line">  int index = -1;</div><div class="line">  int[] valid = new int[ops.length];</div><div class="line">  for (int i = 0; i &lt; ops.length; i++) &#123;</div><div class="line">    if (ops[i].equals(&quot;C&quot;)) &#123;</div><div class="line">      ans -= valid[index--];</div><div class="line">      continue;</div><div class="line">    &#125;</div><div class="line">    if (ops[i].equals(&quot;D&quot;)) &#123;</div><div class="line">      int d = valid[index] * 2;</div><div class="line">      valid[++index] = d;</div><div class="line">      ans += d;</div><div class="line">      continue;</div><div class="line">    &#125;</div><div class="line">    if (ops[i].equals(&quot;+&quot;)) &#123;</div><div class="line">      int d = valid[index] + valid[index - 1];</div><div class="line">      valid[++index] = d;</div><div class="line">      ans += d;</div><div class="line">      continue;</div><div class="line">    &#125;</div><div class="line">    index++;</div><div class="line">    valid[index] = Integer.parseInt(ops[i]);</div><div class="line">    ans += Integer.parseInt(ops[i]);</div><div class="line">  &#125;</div><div class="line">  return ans;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/17/android-zygote/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/17/android-zygote/" itemprop="url">Zygote</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-17T00:00:00Z">
                2017-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="zygot-孵化器"><a href="#zygot-孵化器" class="headerlink" title="zygot 孵化器"></a>zygot 孵化器</h1><ul>
<li><a href="#系统启动-zygote-进程">系统启动 zygote 进程</a></li>
<li><a href="#系统进入-zygote-进程">系统进入zygote进程</a><ul>
<li><a href="#启用无多线程模式">启用无多线程模式</a></li>
<li><a href="#获取底层传入-main-函数的参数">获取底层传入main函数的参数</a></li>
<li><a href="#注册-Socket-，用于进程间通信">注册Socket，用于进程间通信</a></li>
<li><a href="#预加载公共类与资源">预加载公共类与资源</a><ul>
<li><a href="#预加载公共类">预加载公共类</a></li>
<li><a href="#预加载公共资源">预加载公共资源</a></li>
</ul>
</li>
<li><a href="#停止无多线程模式">停止无多线程模式</a></li>
<li><a href="#创建-SystemServer">创建SystemServer</a></li>
<li><a href="#等待接受应用的-socket-请求">等待接受应用的socket请求</a></li>
</ul>
</li>
<li><a href="#孵化-systemserver-进程">孵化SystemServer进程</a></li>
<li><a href="#孵化-application-进程">孵化 Application 进程</a></li>
<li><a href="#tips">Tips</a></li>
</ul>
<h3 id="系统启动-zygote-进程"><a href="#系统启动-zygote-进程" class="headerlink" title="系统启动 zygote 进程"></a>系统启动 zygote 进程</h3><p>即android系统的启动，分为以下几步：</p>
<ul>
<li><em>启动电源以及系统启动</em><br>按下电源键时，引导芯片代码开始从预定义的地方(固化在ROM)开始执行。加载引导程序Bootloader到RAM，然后执行</li>
<li><em>引导程序Bootloader</em><br>引导程序是在Android OS开始运行前的一个小程序，它的主要作用是把OS拉起来并运行</li>
<li><em>Linux内核启动</em><br>内核启动时，设置缓存，被保护存储器，加载列表，加载驱动。当内核完成系统设置，它首先在系统文件中寻找init文件，<br>然后启动root进程或者系统的第一个进程</li>
<li><em>init进程启动</em><ul>
<li>创建一些文件夹并挂载设备</li>
<li>初始化和启动属性服务(类似win平台的注册表)</li>
<li>解析init.rc配置文件并启动zygote进程</li>
</ul>
</li>
</ul>
<p><a href="http://blog.jobbole.com/67931/" target="_blank" rel="external">android 系统启动过程</a></p>
<p><a href="http://blog.csdn.net/fu_kevin0606/article/details/53469076" target="_blank" rel="external">init.rc代码启动zygote进程</a></p>
<p><a href="http://blog.csdn.net/hongbochen1223/article/details/56331690" target="_blank" rel="external">Android初始化语言</a></p>
<p><a href="https://github.com/StephenRJ/cm12_system_core_rootdir" target="_blank" rel="external">init.rc源码</a>，基于aosp的，是cm的，cm现在也没了。。</p>
<p><img src="/images/app_main.png" alt="p"></p>
<h3 id="系统进入-zygote-进程"><a href="#系统进入-zygote-进程" class="headerlink" title="系统进入 zygote 进程"></a>系统进入 zygote 进程</h3><p>即zygote的初始化，在调用完ZygoteInit的main函数后，Zygote就进入了Java世界，在此可以看到启动动画。<br><img src="/images/ZygoteInit.png" alt="p"></p>
<ul>
<li><p>启用无多线程模式</p>
<p>标志着孵化器开始，确保创建子线程会抛出异常<br>考虑到多线程下，资源尚未加载完成的处理问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ZygoteHooks.startZygoteNoThreadCreation();</div></pre></td></tr></table></figure>
</li>
<li><p>获取底层传入main函数的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">boolean startSystemServer = false;</div><div class="line">String socketName = &quot;zygote&quot;; //socketName为zygote</div><div class="line">String abiList = null;</div><div class="line">for (int i = 1; i &lt; argv.length; i++) &#123;</div><div class="line">    if (&quot;start-system-server&quot;.equals(argv[i])) &#123;</div><div class="line">        startSystemServer = true; //start-system-server 在参数列表中，startSystemServer为true</div><div class="line">    &#125; else if (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">        abiList = argv[i].substring(ABI_LIST_ARG.length());//设置abi列表</div><div class="line">    &#125; else if (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</div><div class="line">        socketName = argv[i].substring(SOCKET_NAME_ARG.length()); //如果参数列表指定了socketName，就重新设置socketName</div><div class="line">    &#125; else &#123;</div><div class="line">        throw new RuntimeException(&quot;Unknown command line argument: &quot; + argv[i]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>注册Socket，用于进程间通信</p>
<p> Socket的监听方式为使用Linux系统调用select()函数监听文件描述符，当该文件描述符上有数据时，自动触发中断，在中断处理函数中去读取文件描述符上的数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">private static void registerZygoteSocket(String socketName) &#123;</div><div class="line">    if (sServerSocket == null) &#123;</div><div class="line">        int fileDesc;</div><div class="line">        final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;//拼接完整的socketName</div><div class="line">        try &#123;</div><div class="line">            String env = System.getenv(fullSocketName);//获取环境变量</div><div class="line">            fileDesc = Integer.parseInt(env);</div><div class="line">        &#125; catch (RuntimeException ex) &#123;</div><div class="line">            throw new RuntimeException(fullSocketName + &quot; unset or invalid&quot;, ex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            FileDescriptor fd = new FileDescriptor();</div><div class="line">            fd.setInt$(fileDesc);//设置文件描述符</div><div class="line">            sServerSocket = new LocalServerSocket(fd);</div><div class="line">        &#125; catch (IOException ex) &#123;</div><div class="line">            throw new RuntimeException(</div><div class="line">                    &quot;Error binding to local socket &apos;&quot; + fileDesc + &quot;&apos;&quot;, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>预加载公共类与资源</p>
<p>  在Android系统中有很多的公共资源，所有的程序都会用到。而Zygote创建应用程序进程过程，其实就是复制自身进程地址空间作为应用程序进程的地址空间，因此在Zygote中<br>  加载的类和资源都可以由Zygote孵化的应用程序共享。因此可以在Zygote中加载公共类与资源，当某个应用程序启动时，只要加载自身特有的类与资源即可，可以提高软件的启动速度。<br>  代价是增加了系统重启的时间。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">static void preload() &#123;</div><div class="line">    Log.d(TAG, &quot;begin preload&quot;);</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, &quot;BeginIcuCachePinning&quot;);</div><div class="line">    beginIcuCachePinning();</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, &quot;PreloadClasses&quot;);</div><div class="line">    preloadClasses();</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, &quot;PreloadResources&quot;);</div><div class="line">    preloadResources();</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_DALVIK, &quot;PreloadOpenGL&quot;);</div><div class="line">    preloadOpenGL();</div><div class="line">    Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">    preloadSharedLibraries();</div><div class="line">    preloadTextResources();</div><div class="line">    // Ask the WebViewFactory to do any initialization that must run in the zygote process,</div><div class="line">    // for memory sharing purposes.</div><div class="line">    WebViewFactory.prepareWebViewInZygote();</div><div class="line">    endIcuCachePinning();</div><div class="line">    warmUpJcaProviders();</div><div class="line">    Log.d(TAG, &quot;end preload&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>预加载公共类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * The path of a file that contains classes to preload.</div><div class="line"> * 预加载类的文件路径</div><div class="line"> */</div><div class="line">private static final String PRELOADED_CLASSES = &quot;/system/etc/preloaded-classes&quot;;</div><div class="line">private static final int UNPRIVILEGED_GID = 9999;</div><div class="line">private static final int ROOT_UID = 0;</div><div class="line"></div><div class="line">private static void preloadClasses() &#123;</div><div class="line">    final VMRuntime runtime = VMRuntime.getRuntime();</div><div class="line"></div><div class="line">    InputStream is;</div><div class="line">    try &#123;</div><div class="line">        is = new FileInputStream(PRELOADED_CLASSES);//将classes文件转变为文件输入流</div><div class="line">    &#125; catch (FileNotFoundException e) &#123;</div><div class="line">        Log.e(TAG, &quot;Couldn&apos;t find &quot; + PRELOADED_CLASSES + &quot;.&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Log.i(TAG, &quot;Preloading classes...&quot;);</div><div class="line">    long startTime = SystemClock.uptimeMillis();//开始预加载的时间</div><div class="line"></div><div class="line">    // Drop root perms while running static initializers.</div><div class="line">    // 运行静态初始化时，废弃root权限</div><div class="line">    final int reuid = Os.getuid();</div><div class="line">    final int regid = Os.getgid();</div><div class="line"></div><div class="line">    // We need to drop root perms only if we&apos;re already root. In the case of &quot;wrapped&quot;</div><div class="line">    // processes (see WrapperInit), this function is called from an unprivileged uid</div><div class="line">    // and gid.</div><div class="line">    // 已经root的设备我们需要废弃root权限。</div><div class="line">    boolean droppedPriviliges = false;</div><div class="line">    if (reuid == ROOT_UID &amp;&amp; regid == ROOT_GID) &#123;</div><div class="line">        try &#123;</div><div class="line">            Os.setregid(ROOT_GID, UNPRIVILEGED_GID);</div><div class="line">            Os.setreuid(ROOT_UID, UNPRIVILEGED_UID);</div><div class="line">        &#125; catch (ErrnoException ex) &#123;</div><div class="line">            throw new RuntimeException(&quot;Failed to drop root&quot;, ex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        droppedPriviliges = true;//废弃root特权</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Alter the target heap utilization.  With explicit GCs this</div><div class="line">    // is not likely to have any effect.</div><div class="line">    float defaultUtilization = runtime.getTargetHeapUtilization();</div><div class="line">    runtime.setTargetHeapUtilization(0.8f);</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        BufferedReader br</div><div class="line">            = new BufferedReader(new InputStreamReader(is), 256);//classes文件输入流封装成BufferReader</div><div class="line"></div><div class="line">        int count = 0;</div><div class="line">        String line;</div><div class="line">        while ((line = br.readLine()) != null) &#123;</div><div class="line">            // Skip comments and blank lines.</div><div class="line">            // 过滤空行</div><div class="line">            line = line.trim();</div><div class="line">            if (line.startsWith(&quot;#&quot;) || line.equals(&quot;&quot;)) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_DALVIK, &quot;PreloadClass &quot; + line);</div><div class="line">            try &#123;</div><div class="line">                if (false) &#123;</div><div class="line">                    Log.v(TAG, &quot;Preloading &quot; + line + &quot;...&quot;);</div><div class="line">                &#125;</div><div class="line">                // Load and explicitly initialize the given class. Use</div><div class="line">                // Class.forName(String, boolean, ClassLoader) to avoid repeated stack lookups</div><div class="line">                // (to derive the caller&apos;s class-loader). Use true to force initialization, and</div><div class="line">                // null for the boot classpath class-loader (could as well cache the</div><div class="line">                // class-loader of this class in a variable).</div><div class="line">                // 加载并且明确地初始化指定的类</div><div class="line">                // 使用反射避免重复的栈查找</div><div class="line">                // true用来强制初始化</div><div class="line">                // null表示使用根路径的类加载器</div><div class="line">                Class.forName(line, true, null);</div><div class="line">                count++;</div><div class="line">            &#125; catch (ClassNotFoundException e) &#123;</div><div class="line">                Log.w(TAG, &quot;Class not found for preloading: &quot; + line);</div><div class="line">            &#125; catch (UnsatisfiedLinkError e) &#123;</div><div class="line">                Log.w(TAG, &quot;Problem preloading &quot; + line + &quot;: &quot; + e);</div><div class="line">            &#125; catch (Throwable t) &#123;</div><div class="line">                Log.e(TAG, &quot;Error preloading &quot; + line + &quot;.&quot;, t);</div><div class="line">                if (t instanceof Error) &#123;</div><div class="line">                    throw (Error) t;</div><div class="line">                &#125;</div><div class="line">                if (t instanceof RuntimeException) &#123;</div><div class="line">                    throw (RuntimeException) t;</div><div class="line">                &#125;</div><div class="line">                throw new RuntimeException(t);</div><div class="line">            &#125;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Log.i(TAG, &quot;...preloaded &quot; + count + &quot; classes in &quot;</div><div class="line">                + (SystemClock.uptimeMillis()-startTime) + &quot;ms.&quot;);//打印预加载时间</div><div class="line">    &#125; catch (IOException e) &#123;</div><div class="line">        Log.e(TAG, &quot;Error reading &quot; + PRELOADED_CLASSES + &quot;.&quot;, e);</div><div class="line">    &#125; finally &#123;</div><div class="line">        IoUtils.closeQuietly(is);</div><div class="line">        // Restore default.</div><div class="line">        runtime.setTargetHeapUtilization(defaultUtilization);</div><div class="line"></div><div class="line">        // Fill in dex caches with classes, fields, and methods brought in by preloading.</div><div class="line">        // 用预加载的类，字段，方法填充dex缓存空间。</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, &quot;PreloadDexCaches&quot;);</div><div class="line">        runtime.preloadDexCaches();</div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);</div><div class="line"></div><div class="line">        // Bring back root. We&apos;ll need it later if we&apos;re in the zygote.</div><div class="line">        // 恢复root权限。如果在zygote中，待会儿要用。</div><div class="line">        if (droppedPriviliges) &#123;</div><div class="line">            try &#123;</div><div class="line">                Os.setreuid(ROOT_UID, ROOT_UID);</div><div class="line">                Os.setregid(ROOT_GID, ROOT_GID);</div><div class="line">            &#125; catch (ErrnoException ex) &#123;</div><div class="line">                throw new RuntimeException(&quot;Failed to restore root&quot;, ex);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>预加载公共资源</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Used to pre-load resources.  We hold a global reference on it so it</div><div class="line"> * never gets destroyed.</div><div class="line"> * 用来预加载资源。对其持有全局引用，因此永远不会被销毁。</div><div class="line"> */</div><div class="line">private static Resources mResources;</div><div class="line">private static void preloadResources() &#123;</div><div class="line">    final VMRuntime runtime = VMRuntime.getRuntime();</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        mResources = Resources.getSystem();</div><div class="line">        mResources.startPreloading();</div><div class="line">        if (PRELOAD_RESOURCES) &#123;</div><div class="line">            Log.i(TAG, &quot;Preloading resources...&quot;);</div><div class="line"></div><div class="line">            long startTime = SystemClock.uptimeMillis();</div><div class="line">            TypedArray ar = mResources.obtainTypedArray(</div><div class="line">                    com.android.internal.R.array.preloaded_drawables);//要预加载的资源</div><div class="line">            int N = preloadDrawables(ar); //预加载drawables</div><div class="line">            ar.recycle();</div><div class="line">            Log.i(TAG, &quot;...preloaded &quot; + N + &quot; resources in &quot;</div><div class="line">                    + (SystemClock.uptimeMillis()-startTime) + &quot;ms.&quot;);//预加载drawables使用的时间</div><div class="line"></div><div class="line">            startTime = SystemClock.uptimeMillis();</div><div class="line">            ar = mResources.obtainTypedArray(</div><div class="line">                    com.android.internal.R.array.preloaded_color_state_lists);</div><div class="line">            N = preloadColorStateLists(ar);//预加载color state</div><div class="line">            ar.recycle();</div><div class="line">            Log.i(TAG, &quot;...preloaded &quot; + N + &quot; resources in &quot;</div><div class="line">                    + (SystemClock.uptimeMillis()-startTime) + &quot;ms.&quot;);//预加载color state使用的时间</div><div class="line"></div><div class="line">            //The device supports freeform window management. Windows have title bars and can be moved</div><div class="line">            //and resized. If you set this to true, you also need to add</div><div class="line">            //PackageManager.FEATURE_FREEFORM_WINDOW_MANAGEMENT feature to your device specification.</div><div class="line">            //The duplication is necessary, because this information is used before the features are</div><div class="line">            //available to the system.</div><div class="line">            if (mResources.getBoolean(</div><div class="line">                    com.android.internal.R.bool.config_freeformWindowManagement)) &#123;</div><div class="line">                    //如果支持自由的窗口管理，预加载多窗口drawables</div><div class="line">                startTime = SystemClock.uptimeMillis();</div><div class="line">                ar = mResources.obtainTypedArray(</div><div class="line">                        com.android.internal.R.array.preloaded_freeform_multi_window_drawables);</div><div class="line">                N = preloadDrawables(ar);</div><div class="line">                ar.recycle();</div><div class="line">                Log.i(TAG, &quot;...preloaded &quot; + N + &quot; resource in &quot;</div><div class="line">                        + (SystemClock.uptimeMillis() - startTime) + &quot;ms.&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mResources.finishPreloading();</div><div class="line">    &#125; catch (RuntimeException e) &#123;</div><div class="line">        Log.w(TAG, &quot;Failure preloading resources&quot;, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>停止无多线程模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ZygoteHooks.stopZygoteNoThreadCreation();</div></pre></td></tr></table></figure>
</li>
<li><p>创建SystemServer</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (startSystemServer) &#123;   //startSysteServer为true  </div><div class="line">    startSystemServer(abiList, socketName);     </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <a href="#孵化 SystemServer 进程">孵化 SystemServer 进程</a></p>
<ul>
<li>等待接受应用的socket请求</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">private static void runSelectLoop(String abiList) throws MethodAndArgsCaller &#123;</div><div class="line">    ArrayList&lt;FileDescriptor&gt; fds = new ArrayList&lt;FileDescriptor&gt;();</div><div class="line">    ArrayList&lt;ZygoteConnection&gt; peers = new ArrayList&lt;ZygoteConnection&gt;();</div><div class="line"></div><div class="line">    fds.add(sServerSocket.getFileDescriptor());</div><div class="line">    peers.add(null);</div><div class="line"></div><div class="line">    while (true) &#123;</div><div class="line">        StructPollfd[] pollFds = new StructPollfd[fds.size()];</div><div class="line">        for (int i = 0; i &lt; pollFds.length; ++i) &#123;</div><div class="line">            pollFds[i] = new StructPollfd();</div><div class="line">            pollFds[i].fd = fds.get(i);</div><div class="line">            pollFds[i].events = (short) POLLIN;</div><div class="line">        &#125;</div><div class="line">        try &#123;</div><div class="line">            Os.poll(pollFds, -1);</div><div class="line">        &#125; catch (ErrnoException ex) &#123;</div><div class="line">            throw new RuntimeException(&quot;poll failed&quot;, ex);</div><div class="line">        &#125;</div><div class="line">        for (int i = pollFds.length - 1; i &gt;= 0; --i) &#123;</div><div class="line">            if ((pollFds[i].revents &amp; POLLIN) == 0) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            if (i == 0) &#123;</div><div class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                peers.add(newPeer);</div><div class="line">                fds.add(newPeer.getFileDesciptor());</div><div class="line">            &#125; else &#123;</div><div class="line">                boolean done = peers.get(i).runOnce();</div><div class="line">                if (done) &#123;</div><div class="line">                    peers.remove(i);</div><div class="line">                    fds.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="孵化-SystemServer-进程"><a href="#孵化-SystemServer-进程" class="headerlink" title="孵化 SystemServer 进程"></a>孵化 SystemServer 进程</h3><p><img src="/imges/system_server.png" alt="system_server"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Prepare the arguments and fork for the system server process.</div><div class="line"> */</div><div class="line">private static boolean startSystemServer(String abiList, String socketName)</div><div class="line">        throws MethodAndArgsCaller, RuntimeException &#123;</div><div class="line">    long capabilities = posixCapabilitiesAsBits(</div><div class="line">        OsConstants.CAP_IPC_LOCK,</div><div class="line">        OsConstants.CAP_KILL,</div><div class="line">        OsConstants.CAP_NET_ADMIN,</div><div class="line">        OsConstants.CAP_NET_BIND_SERVICE,</div><div class="line">        OsConstants.CAP_NET_BROADCAST,</div><div class="line">        OsConstants.CAP_NET_RAW,</div><div class="line">        OsConstants.CAP_SYS_MODULE,</div><div class="line">        OsConstants.CAP_SYS_NICE,</div><div class="line">        OsConstants.CAP_SYS_RESOURCE,</div><div class="line">        OsConstants.CAP_SYS_TIME,</div><div class="line">        OsConstants.CAP_SYS_TTY_CONFIG</div><div class="line">    );</div><div class="line">    /* Containers run without this capability, so avoid setting it in that case */</div><div class="line">    if (!SystemProperties.getBoolean(PROPERTY_RUNNING_IN_CONTAINER, false)) &#123;</div><div class="line">        capabilities |= posixCapabilitiesAsBits(OsConstants.CAP_BLOCK_SUSPEND);</div><div class="line">    &#125;</div><div class="line">    /* Hardcoded command line to start the system server */</div><div class="line">    String args[] = &#123;</div><div class="line">        &quot;--setuid=1000&quot;,</div><div class="line">        &quot;--setgid=1000&quot;,</div><div class="line">        &quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010&quot;,</div><div class="line">        &quot;--capabilities=&quot; + capabilities + &quot;,&quot; + capabilities,</div><div class="line">        &quot;--nice-name=system_server&quot;,//进程名字</div><div class="line">        &quot;--runtime-args&quot;,</div><div class="line">        &quot;com.android.server.SystemServer&quot;,//包名</div><div class="line">    &#125;;</div><div class="line">    ZygoteConnection.Arguments parsedArgs = null;</div><div class="line"></div><div class="line">    int pid;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        parsedArgs = new ZygoteConnection.Arguments(args);//参数封装</div><div class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</div><div class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</div><div class="line"></div><div class="line">        /* Request to fork the system server process */</div><div class="line">        pid = Zygote.forkSystemServer(//孵化系统服务进程，尝试获取pid</div><div class="line">                parsedArgs.uid, parsedArgs.gid,</div><div class="line">                parsedArgs.gids,</div><div class="line">                parsedArgs.debugFlags,</div><div class="line">                null,</div><div class="line">                parsedArgs.permittedCapabilities,</div><div class="line">                parsedArgs.effectiveCapabilities);</div><div class="line">    &#125; catch (IllegalArgumentException ex) &#123;</div><div class="line">        throw new RuntimeException(ex);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* For child process */</div><div class="line">    if (pid == 0) &#123;//fork子进程成功</div><div class="line">        if (hasSecondZygote(abiList)) &#123;</div><div class="line">            waitForSecondaryZygote(socketName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        handleSystemServerProcess(parsedArgs);//运行系统服务，SystemServer拥有了自己的进程</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>创建SystemServer进程，android的所有服务循环框架都建立在SystemServer上</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public static int forkSystemServer(int uid, int gid, int[] gids, int debugFlags,</div><div class="line">        int[][] rlimits, long permittedCapabilities, long effectiveCapabilities) &#123;</div><div class="line">    VM_HOOKS.preFork();// 停止所有守护进程</div><div class="line">    int pid = nativeForkSystemServer( //native函数孵化进程</div><div class="line">            uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);</div><div class="line">    // Enable tracing as soon as we enter the system_server.</div><div class="line">    if (pid == 0) &#123;</div><div class="line">        Trace.setTracingEnabled(true);</div><div class="line">    &#125;</div><div class="line">    VM_HOOKS.postForkCommon(); // 重新运行各个守护进程</div><div class="line">    return pid;</div><div class="line">&#125;</div><div class="line"></div><div class="line">native private static int nativeForkSystemServer(int uid, int gid, int[] gids, int debugFlags,</div><div class="line">        int[][] rlimits, long permittedCapabilities, long effectiveCapabilities);</div></pre></td></tr></table></figure>
<pre><code>调用底层进行fork system server进程。如果创建出的进程pid=0，说明该进程为Zygote的子进程，系统会为其设置uid，gid
如果pid &gt; 0 ，说明该进程为SystemServer的进程号，Zygote会检查一下该进程有没有died，如果true，重启Zygote进程。
SystemServer进程创建完成后，就会重新启动垃圾回收后台进程。
</code></pre><ul>
<li>运行SystemServer</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Finish remaining work for the newly forked system server process.</div><div class="line"> */</div><div class="line">private static void handleSystemServerProcess(</div><div class="line">        ZygoteConnection.Arguments parsedArgs)</div><div class="line">        throws ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line"></div><div class="line">    closeServerSocket(); //关闭zygote中的socket</div><div class="line"></div><div class="line">    // set umask to 0077 so new files and directories will default to owner-only permissions.</div><div class="line">    Os.umask(S_IRWXG | S_IRWXO);</div><div class="line"></div><div class="line">    if (parsedArgs.niceName != null) &#123;</div><div class="line">        Process.setArgV0(parsedArgs.niceName);// 设置进程名</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final String systemServerClasspath = Os.getenv(&quot;SYSTEMSERVERCLASSPATH&quot;); // 获取SystemServer的classpath</div><div class="line">    if (systemServerClasspath != null) &#123;</div><div class="line">        performSystemServerDexOpt(systemServerClasspath); //对改路径中的文件做dexopt优化</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (parsedArgs.invokeWith != null) &#123;</div><div class="line">        String[] args = parsedArgs.remainingArgs;</div><div class="line">        // If we have a non-null system server class path, we&apos;ll have to duplicate the</div><div class="line">        // existing arguments and append the classpath to it. ART will handle the classpath</div><div class="line">        // correctly when we exec a new process.</div><div class="line">        if (systemServerClasspath != null) &#123;</div><div class="line">            String[] amendedArgs = new String[args.length + 2];</div><div class="line">            amendedArgs[0] = &quot;-cp&quot;;</div><div class="line">            amendedArgs[1] = systemServerClasspath;</div><div class="line">            System.arraycopy(parsedArgs.remainingArgs, 0, amendedArgs, 2, parsedArgs.remainingArgs.length);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                VMRuntime.getCurrentInstructionSet(), null, args);</div><div class="line">    &#125; else &#123;</div><div class="line">        ClassLoader cl = null;</div><div class="line">        if (systemServerClasspath != null) &#123;</div><div class="line">        // 为SystemServer创建ClassLoader，使其可以进入平台的私有本地类库</div><div class="line">            cl = createSystemServerClassLoader(systemServerClasspath,</div><div class="line">                                               parsedArgs.targetSdkVersion);</div><div class="line"></div><div class="line">            Thread.currentThread().setContextClassLoader(cl);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /*</div><div class="line">         * Pass the remaining arguments to SystemServer.</div><div class="line">         * 将剩余的参数传递给SystemServer</div><div class="line">         */</div><div class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* should never reach here */</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SystemServer.main中创建线程注册各种service到servicemanager中。</p>
<h4 id="HOME启动"><a href="#HOME启动" class="headerlink" title="HOME启动"></a>HOME启动</h4><p>在启动完所有的Android服务后，通知各个服务，系统已经准备就绪。</p>
<p>startSystemUi 方法启动HOME界面。</p>
<p>至此，android系统完成了引导过程，这是ACTION_BOOT_COMPLETED开机启动广播就会发出去。</p>
<h3 id="孵化-Application-进程"><a href="#孵化-Application-进程" class="headerlink" title="孵化 Application 进程"></a>孵化 Application 进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public static int forkAndSpecialize(int uid, int gid, int[] gids, int debugFlags,</div><div class="line">      int[][] rlimits, int mountExternal, String seInfo, String niceName, int[] fdsToClose,</div><div class="line">      String instructionSet, String appDataDir) &#123;</div><div class="line">    VM_HOOKS.preFork();</div><div class="line">    int pid = nativeForkAndSpecialize(</div><div class="line">              uid, gid, gids, debugFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,</div><div class="line">              instructionSet, appDataDir);</div><div class="line">    // Enable tracing as soon as possible for the child process.</div><div class="line">    if (pid == 0) &#123;</div><div class="line">        Trace.setTracingEnabled(true);</div><div class="line"></div><div class="line">        // Note that this event ends at the end of handleChildProc,</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;PostFork&quot;);</div><div class="line">    &#125;</div><div class="line">    VM_HOOKS.postForkCommon();</div><div class="line">    return pid;</div><div class="line">&#125;</div><div class="line"></div><div class="line">native private static int nativeForkAndSpecialize(int uid, int gid, int[] gids,int debugFlags,</div><div class="line">      int[][] rlimits, int mountExternal, String seInfo, String niceName, int[] fdsToClose,</div><div class="line">      String instructionSet, String appDataDir);</div></pre></td></tr></table></figure>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li>为所有Java程序复刻一个虚拟机实例</li>
<li>应用程序的入口是<code>ActivityThread$main()</code>，而zygote就是为应用程序创建进程的</li>
<li><p>大部分应用程序由zygote创建进程，但是系统引导进程、init进程不是</p>
<h4 id="android中的zygote分两块"><a href="#android中的zygote分两块" class="headerlink" title="android中的zygote分两块"></a>android中的zygote分两块</h4><ol>
<li>C/C++编写的zygote，主要用来为系统服务和应用程序复刻进程的</li>
<li>Java编写的zygote接口，负责为系统服务和应用程序调用C/C++ zygote接口执行复刻，创建虚拟机进程</li>
</ol>
<h4 id="android中的service分两种"><a href="#android中的service分两种" class="headerlink" title="android中的service分两种"></a>android中的service分两种</h4><ol>
<li>NativeService</li>
<li>SystemService，即本project示例集所研究</li>
</ol>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/09/android-memory-leak/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/09/android-memory-leak/" itemprop="url">Android 内存泄露</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-09T00:00:00Z">
                2017-11-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="什么是内存泄露"><a href="#什么是内存泄露" class="headerlink" title="什么是内存泄露"></a>什么是内存泄露</h4><p>jvm会根据可达性算法,计算每个对象是否可被回收,如果有对象被持有引用,即可达,并且该对象已经无用.此时对象不可被回收但是占用内存的这种状态成为内存泄露.如果内存泄露情况比较多,很有可能引起OOM异常.</p>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><ul>
<li>根源在android组件的生命周期和底层Java对象的生命周期不是直接匹配的</li>
<li>一个应用程序的启动分为三步:<ul>
<li>复刻受精卵进程</li>
<li>系统为该进程添加运行时执行环境</li>
<li>运行时执行环境加载可执行文件,即调用onCreate()方法启动应用程序</li>
</ul>
</li>
<li>应用程序的生命周期理想状态下,是在运行时调用onTerminate()方法是结束,但一般情况下都不会如此.应用程序的生命周期是从第一个的组件被创建到最后一个组件被销毁,很有可能在onTerminate()方法还没有调用,当前进程已经被回收掉了.即应用程序的存活时间小于了Java对象的存活时间.</li>
<li>简单来说,就是长生命周期的对象引用了短生命周期的对象</li>
<li>应用程序生命周期内,考虑多线程情况下,线程的存活时间取决于当前任务的长度,任务就是应用程序代码定义的,CPU有序顺序执行的指令,所以线程如果比所在组件生命长,很有可能是这样,往往容易引起内存泄露</li>
</ul>
<h4 id="常见情况及解决"><a href="#常见情况及解决" class="headerlink" title="常见情况及解决"></a>常见情况及解决</h4><table>
<thead>
<tr>
<th style="text-align:center">情况</th>
<th style="text-align:center">解决</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Thread + Handler</td>
<td style="text-align:center">优先考虑静态成员类</td>
</tr>
<tr>
<td style="text-align:center">数据库连接,IO,Socket连接,Bitmap</td>
<td style="text-align:center">及时关闭,及时释放</td>
</tr>
<tr>
<td style="text-align:center">静态容器,静态类,持有对短生命周期的对象</td>
<td style="text-align:center">及时删除对象,使用弱引用,软引用</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/29/android-system-service-Activity-Manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/29/android-system-service-Activity-Manager/" itemprop="url">Android系统服务：ActivityManager</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-29T00:00:00Z">
                2017-09-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android-System-Framework/" itemprop="url" rel="index">
                    <span itemprop="name">Android System Framework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="提要"><a href="#提要" class="headerlink" title="提要"></a>提要</h4><p>AMS作为重要的系统服务，涉及到的知识如下：</p>
<ul>
<li>Binder机制</li>
<li><a href="https://github.com/xusx1024/AndroidSystemServiceSample/blob/master/aidldemo/README.md" target="_blank" rel="external">AIDL机制</a></li>
<li><a href="https://github.com/xusx1024/AndroidSystemServiceSample/blob/master/doc/zygot.md" target="_blank" rel="external">Zygote</a>机制，即系统启动过程，包括SystemServer的初始化</li>
<li>应用程序启动过程</li>
<li>Activity的启动过程</li>
</ul>
<p>AMS相关的应用：</p>
<ul>
<li>manifest文件中activity标签的所有属性    </li>
<li>adb shell am * 相关的命令</li>
<li>ActivityManager 相关的API使用</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/19/be-better/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/19/be-better/" itemprop="url">拂拭</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-19T00:00:00Z">
                2017-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Others/" itemprop="url" rel="index">
                    <span itemprop="name">Others</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="2017年9月19日"><a href="#2017年9月19日" class="headerlink" title="2017年9月19日"></a>2017年9月19日</h4><p> 夫君子之行：静以修身，俭以养德。非淡泊无以明志，非宁静无以致远。夫学需静也，才需学也，非学无以广才，非志无以成学。淫慢则不能励精，险燥则不能冶性。年与时驰，意与日去，遂成枯落，多不接世，悲守穷庐，将复何及！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/22/license-introduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/22/license-introduce/" itemprop="url">代码开源协议</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-22T00:00:00Z">
                2017-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Others/" itemprop="url" rel="index">
                    <span itemprop="name">Others</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="License"><a href="#License" class="headerlink" title="License"></a>License</h4><p>License是软件的授权许可，里面详尽表述了你获得代码后拥有的权利，可以对别人的作品进行何种操作，何种操作又是被禁止的。软件协议可分为开源和商业。<br>商业协议，又叫法律声明、许可协议，这由专门的律师撰写。<br>开源协议即本文所介绍。<br>如果您只想快速确定自己的代码适合哪种协议，那么<a href="https://choosealicense.com/" target="_blank" rel="external">Choose an open source license</a>可以帮您快速抉择。</p>
<h4 id="对比表"><a href="#对比表" class="headerlink" title="对比表"></a>对比表</h4><table>
<thead>
<tr>
<th style="text-align:center">协议</th>
<th style="text-align:center">描述</th>
<th style="text-align:center">要求</th>
<th style="text-align:center">允许</th>
<th style="text-align:center">禁止</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/apache-2.0/" target="_blank" rel="external">Apache</a></td>
<td style="text-align:center">一个较宽松且简明地指出了专利授权的协议</td>
<td style="text-align:center"><code>协议和版权信息</code>     <code>声明变更</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>专利授权</code> <code>私用</code> <code>附加协议</code></td>
<td style="text-align:center"><code>责任承担</code> <code>商标使用</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/gpl-2.0/" target="_blank" rel="external">GPL</a></td>
<td style="text-align:center">此协议是应用最为广泛的开源协议，拥有较强的版权自由要求。衍生代码的分发需开源并且也要遵守此协议。此协议有许多变种，要求略有不同</td>
<td style="text-align:center"><code>公开源码</code> <code>协议和版权信息</code> <code>声明变更</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>专利授权</code> <code>私用</code></td>
<td style="text-align:center"><code>责任承担</code> <code>附加协议</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/mit/" target="_blank" rel="external">MIT</a></td>
<td style="text-align:center">宽松简单且精要的一个协议。在适当表明来源及免责的情况下，它允许你对代码进行任何形式的使用</td>
<td style="text-align:center"><code>协议和版权信息</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>私用</code> <code>附加协议</code></td>
<td style="text-align:center"><code>责任承担</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/artistic-2.0/" target="_blank" rel="external">Artistic</a></td>
<td style="text-align:center">Perl社区尤为钟爱此协议。要求更改后的软件不能影响原软件的使用</td>
<td style="text-align:center"><code>协议和版权信息</code>    <code>声明变更</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>私用</code> <code>附加协议</code></td>
<td style="text-align:center"><code>责任承担</code> <code>商标使用</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/bsd-2-clause/" target="_blank" rel="external">BSD</a></td>
<td style="text-align:center">较为宽松的协议，包含两个变种<a href="https://choosealicense.com/licenses/bsd-2-clause/" target="_blank" rel="external">BSD 2-Clause</a> 和<a href="https://choosealicense.com/licenses/bsd-3-clause/" target="_blank" rel="external">BSD 3-Clause</a>，两者都与MIT协议只存在细微差异。</td>
<td style="text-align:center"><code>协议和版权信息</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>私用</code> <code>附加协议</code></td>
<td style="text-align:center"><code>责任承担</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/epl-1.0/" target="_blank" rel="external">Eclipse</a></td>
<td style="text-align:center">对商用非常友好的一种协议，可以用于软件的商业授权。包含对专利的优雅授权，并且也可以对相关代码应用商业协议</td>
<td style="text-align:center"><code>公开源码</code> <code>协议和版权信息</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>专利授权</code> <code>私用</code> <code>附加协议</code></td>
<td style="text-align:center"><code>责任承担</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/lgpl-2.1/" target="_blank" rel="external">LGPL</a></td>
<td style="text-align:center">主要用于一些代码库。衍生代码可以以此协议发布(也可用别的)，但与此协议相关的代码必须遵循此协议</td>
<td style="text-align:center"><code>公开源码</code> <code>库引用</code> <code>协议和版权信息</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>专利授权</code> <code>私用</code> <code>附加协议</code></td>
<td style="text-align:center"><code>责任承担</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/mpl-2.0/" target="_blank" rel="external">Mozilla</a></td>
<td style="text-align:center">Mozilla Public License(MPL 2.0)是由Mozilla基金创建维护的。此协议旨在较为宽松的BSD协议和更加互惠的GPL协议中寻找一个折衷点。</td>
<td style="text-align:center"><code>公开源码</code> <code>协议和版权信息</code></td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>专利授权</code> <code>私用</code> <code>附加协议</code></td>
<td style="text-align:center"><code>责任承担</code> <code>商标使用</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/no-license/" target="_blank" rel="external">No license</a></td>
<td style="text-align:center">你保留所以权利，不允许他人分发，复制或者创造衍生物。当你将代码发表在一些网站上时需要遵守该网站的协议，此协议可能包含了一些对你劳动成果的授权许可。比如你将代码发布到GitHub，那么你就必须统一别人可以查看和fork你的代码</td>
<td style="text-align:center"><code>协议和版权信息</code></td>
<td style="text-align:center"><code>商用</code> <code>私用</code></td>
<td style="text-align:center"><code>分发</code> <code>修改</code> <code>附加协议</code></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://choosealicense.com/licenses/unlicense/" target="_blank" rel="external">Unlicense</a></td>
<td style="text-align:center">在许多国家，默认版权归作者自动拥有，所以该协议提供了一种通用的模版，表明你放弃版权，将劳动成果无私贡献出来。你将丧失对作品的全部权利，包括在MIT/X11中定义的无担保权利。</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center"><code>商用</code> <code>分发</code> <code>修改</code> <code>私用</code></td>
<td style="text-align:center"><code>责任承担</code></td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/raspbarry-first/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/raspbarry-first/" itemprop="url">Raspbarry first</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-17T00:00:00Z">
                2017-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Others/" itemprop="url" rel="index">
                    <span itemprop="name">Others</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>想要利用树莓派+DuerOS做一个可以人机交互的家用终端。<br>大概可以给讲故事，背诗词，报时，报天气。<br>车载大概可以导航，实时路况，广播之类。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/17/android-system-service-Account-Manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/17/android-system-service-Account-Manager/" itemprop="url">Android系统服务：AccountManager</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-17T00:00:00Z">
                2017-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android-System-Framework/" itemprop="url" rel="index">
                    <span itemprop="name">Android System Framework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="前面"><a href="#前面" class="headerlink" title="前面"></a>前面</h4><p>以<code>AccountManager</code>为例，read the fucking code.</p>
<h4 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h4><p>可以看到该类遵循Apache协议。也就是说允许商用，私用，分发，修改，专利授权，附件协议，作者不允许商标使用，不承担责任。</p>
<p>详细的各种协议区分，请看：<a href="http://xusx1024.com/2017/08/22/license-introduce/" target="_blank" rel="external">here</a></p>
<h4 id="package"><a href="#package" class="headerlink" title="package"></a>package</h4><p>类所在的包：<code>package android.accounts;</code> </p>
<ul>
<li>AbstractAccountAuthenticator</li>
<li>Account</li>
<li>AccountAuthenticatorActivity</li>
<li>AccountAuthenticatorResponse</li>
<li>AccountManagerCallback</li>
<li>AccountManagerFuture</li>
<li>AccountsException</li>
<li>AuthenticatorDescription</li>
<li>AuthenticatorException</li>
<li>NetworkErrorException</li>
<li>OnAccountsUpdateListener</li>
<li>OperationCanceledException</li>
</ul>
<h4 id="类说明"><a href="#类说明" class="headerlink" title="类说明"></a>类说明</h4><p>This class provides access to a centralized registry of the user’s online accounts.<br>The user enters credentials (username and password) once per account, granting applications access to online resources with “one-click” approval.</p>
<p>此类提供了用户在线账户集中注册的访问。<br>用户为每个账户输入用户密码作为证书，准许应用通过一次授权访问在线资源。</p>
<p></p><p>Different online services have different ways of handling accounts and authentication, so the account manager uses pluggable <em>authenticator</em> modules for different <em>account types</em>.<br>Authenticators (which may be written by third parties) handle the actual details of validating account credentials and storing account information.<br>For example, Google, Facebook, and Microsoft Exchange each have their own authenticator.</p>
<p>不同的线上服务处理账户和认证有不同的方式，因此账户管理者为不同的账户类型应用可插拔的认证模块。<br>验证者(也许是第三方写入)处理具体的账户证书细节，并且存储账户信息。<br>例如：Google，Facebook,Microsoft Exchange有各自的验证者。</p>
<p></p><p>Many servers support some notion[概念] of an <em>authentication token</em>, which can be used to authenticate a request to the server without sending the user’s actual password.<br>(Auth tokens are normally created with a separate request which does include the user’s credentials.)<br>AccountManager can generate auth tokens for applications, so the application doesn’t need to handle passwords directly.<br>Auth tokens are normally reusable and cached by AccountManager, but must be refreshed periodically[定期].<br>It’s the responsibility of applications to <em>invalidate</em> auth tokens when they stop working so the AccountManager knows it needs to regenerate them.</p>
<p>许多服务支持认证令牌的概念，可以无需用户确切的密码，即可向服务端认证一个请求。<br>(授权令牌通常创建在包含用户证书的一个单独的请求里。)<br>账户管理者可以为应用生成授权令牌，因此应用无需直接操作密码。<br>授权令牌通常是可重用的并由账户管理者缓存，但必须定期刷新。<br>当授权令牌停止工作时，应用的职责是废止这些授权，账户管理者依此得知需要重新生成。</p>
<p></p><p>Applications accessing a server normally go through these steps:</p>
<ul><br><li>Get an instance of AccountManager using {@link #get(Context)}.<br><br></li><li>List the available accounts using {@link #getAccountsByType} or {@link #getAccountsByTypeAndFeatures}.<br>Normally applications will only be interested in accounts with one particular <em>type</em>, which identifies the authenticator.<br>Account <em>features</em> are used to identify particular account subtypes and capabilities[功能].<br>Both the account type and features are authenticator-specific strings, and must be known by the application in coordination with its preferred authenticators.<br><br></li><li>Select one or more of the available accounts, possibly by asking the user for their preference.<br>If no suitable accounts are available, {@link #addAccount} may be called to prompt the user to create an account of the appropriate type.<br><br></li><li><b>Important:</b> If the application is using a previously remembered account selection, it must make sure the account is still in the list of accounts returned by {@link #getAccountsByType}.  Requesting an auth token for an account no longer on the device results in an undefined failure.<br><br></li><li>Request an auth token for the selected account(s) using one of the {@link #getAuthToken} methods or related helpers.<br>Refer to the description of each method for exact usage and error handling details.<br><br></li><li>Make the request using the auth token.  The form of the auth token, the format of the request, and the protocol used are all specific to the service you are accessing.<br>The application may use whatever network and protocol libraries are useful.<br><br></li><li><b>Important:</b> If the request fails with an authentication error, it could be that a cached auth token is stale and no longer honored by the server.<br>The application must call {@link #invalidateAuthToken} to remove the token from the cache, otherwise requests will continue failing!<br>After invalidating the auth token, immediately go back to the “Request an auth token” step above.<br>If the process fails the second time, then it can be treated as a “genuine” authentication failure and the user notified or other appropriate actions taken.<br></li></ul>

<p>应用访问服务一般有以下几个步骤：</p>
<ul><br><li>使用<code>get(Context)</code>获取账户管理者的实例<br></li><li>使用<code>getAccountsByType</code>或者<code>getAccountsByTypeAndFeatures</code>列出可用的账户。<br>通常应用只会被一个特定类型所吸引，该类型可用于识别验证者。<br>账户特征用来识别特定的账户子类型和功能。<br>账户类型和特征是验证者特定的字符串，必须由应用程序与其首选验证着协调知道。<br></li><li>选一或多个可用账户，可能通过询问用户的偏好。<br>如果没有适合的账户可用，指示用户调用<code>addAccount</code>创建一个适当类型的账户。<br></li><li><b>重要：</b>如果应用程序正在使用以前记录的账户选择，一定要确保此账户仍在<code>getAccountsByType</code>返回的账户列表里。<br>为不再在设备上的账户请求授权令牌，会导致未定义的错误。<br></li><li>为选择的账户请求授权令牌使用<code>getAuthToken</code>方法，或者相关的帮助者。<br>参考各个方法的描述，以确定用例使用、错误处理细节。<br></li><li>使用授权令牌发起请求。令牌的形式，请求的格式，使用的协议，这些都由你正在访问的服务指定。<br>应用程序可以使用任何网络和协议库都是可用的。<br></li><li><b>重要：</b>如果请求失败出现了授权错误，可能是缓存的令牌陈旧，不再由服务器兑现。<br>应用程序必须调用<code>invalidateAuthToken</code>去移除缓存的令牌，否则请求就会持续失败！<br>废止授权令牌之后，可以直接重复上面的步骤。<br>如果第二次操作也失败，就可以被对待为真实身份认证失败，用户需要被通知或采取别的行动.<br></li></ul>

<p></p><p>Some AccountManager methods may need to interact with the user to prompt for credentials, present options, or ask the user to add an account.<br>The caller may choose whether to allow AccountManager to directly launch the necessary user interface and wait for the user, or to return an Intent which the caller may use to launch the interface, or (in some cases) to install a notification which the user can select at any time to launch the interface.<br>To have AccountManager launch the interface directly, the caller must supply the current foreground {@link Activity} context.</p>
<p>一些账户管理者方法也许需要与用户交互来提示凭据，呈现选项，或要求用户添加一个账户。<br>调用者可以选择允许账户管理者直接登录必要的用户接口并且等待用户返回，也可以返回一个可以用来登录用户接口的意图，也可以展示一个通知，用户可以在任意时间选择去登录该接口。<br>要让账户管理者直接登录接口，调用者必须提供当前前台活动的上下文。</p>
<p></p><p>Many AccountManager methods take {@link AccountManagerCallback} and {@link Handler} as parameters.<br>These methods return immediately and run asynchronously.<br>If a callback is provided then {@link AccountManagerCallback#run} will be invoked on the Handler’s thread when the request completes, successfully or not.<br>The result is retrieved by calling {@link AccountManagerFuture#getResult()} on the {@link AccountManagerFuture} returned by the method (and also passed to the callback).<br>This method waits for the operation to complete (if necessary) and either returns the result or throws an exception if an error occurred during the operation.<br>To make the request synchronously, call {@link AccountManagerFuture#getResult()} immediately on receiving the future from the method; no callback need be supplied.</p>
<p></p><p>许多账户管理者持有<code>AccountManagerCallback</code>和<code>Handler</code>实例作为参数。<br>这些方法会异步执行并且立即返回。<br>如果一个回调被提供，在请求完成，成功或失败时，<code>AccountManagerCallback</code>将会在Handler的线程中被调用。<br>结果检索调用的方法是<code>AccountManagerFuture#getResult()</code>。<br>如果有必要，此方法等待操作的完成并且无论是返回结果或是在操作过程中产生错误并抛出异常。<br>为了异步执行请求，在接受到方法的未来时，直接调用<code>AccountManagerFuture#getResult()</code>；不需要提供回调。</p>
<p></p><p>Requests which may block, including {@link AccountManagerFuture#getResult()}, must never be called on the application’s main event thread.<br>These operations throw {@link IllegalStateException} if they are used on the main thread.</p>
<p>请求也许会阻塞，包括<code>AccountManagerFuture#getResult()</code>,绝对禁止在应用程序的主线程调用。<br>否则，这些操作会抛出<code>IllegalStateException</code>异常。</p>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><h5 id="静态常量"><a href="#静态常量" class="headerlink" title="静态常量"></a>静态常量</h5><ul>
<li><code>ERROR_CODE_REMOTE_EXCEPTION</code>:远程异常</li>
<li><code>ERROR_CODE_NETWORK_ERROR</code>:网络错误</li>
<li><code>ERROR_CODE_CANCELED</code>:取消</li>
<li><code>ERROR_CODE_INVALID_RESPONSE</code>:无效的响应</li>
<li><code>ERROR_CODE_UNSUPPORTED_OPERATION</code>:不支持的操作</li>
<li><code>ERROR_CODE_BAD_ARGUMENTS</code>:错误的参数</li>
<li><code>ERROR_CODE_BAD_REQUEST</code>:错误的请求</li>
<li><code>ERROR_CODE_BAD_AUTHENTICATION</code>:错误的授权</li>
<li><code>ERROR_CODE_BAD_AUTHENTICATION</code>:错误的已注册用户</li>
<li><code>ERROR_CODE_MANAGEMENT_DISABLED_FOR_ACCOUNT_TYPE</code>:当前账户类型管理失效错误</li>
<li><code>KEY_ACCOUNT_NAME</code>:传值常量键，用于获取账户名</li>
<li><code>KEY_ACCOUNT_TYPE</code>:传值常量键，用于获取账户类型值</li>
<li><code>KEY_AUTHTOKEN</code>:传值常量键，用于获取授权令牌</li>
<li><code>KEY_INTENT</code>:传值常量键，用于启动相关的用户接口页面</li>
<li><code>KEY_PASSWORD</code>:传值常量键，用于获取密码</li>
<li><code>KEY_ACCOUNTS</code>:传值常量键，用于获取账户</li>
<li><code>KEY_ACCOUNT_AUTHENTICATOR_RESPONSE</code>:传值常量键，用于获取账户授权响应</li>
<li><code>KEY_ACCOUNT_MANAGER_RESPONSE</code>:传值常量键，用于获取账户管理者响应</li>
<li><code>KEY_AUTHENTICATOR_TYPES</code>:传值常量键，用于获取授权类型</li>
<li><code>KEY_AUTH_FAILED_MESSAGE</code>:授权失败信息</li>
<li><code>KEY_AUTH_TOKEN_LABEL</code>:授权令牌标签</li>
<li><code>KEY_BOOLEAN_RESULT</code>:结果布尔值</li>
<li><code>KEY_ERROR_CODE</code>:错误码</li>
<li><code>KEY_ERROR_MESSAGE</code>:错误消息</li>
<li><code>KEY_USERDATA</code>:用户数据</li>
<li><code>KEY_LAST_AUTHENTICATED_TIME</code>:上次授权时间</li>
<li><code>KEY_CALLER_UID</code>:调用者的UID</li>
<li><code>KEY_CALLER_PID</code>:调用者的PID</li>
<li><code>KEY_ANDROID_PACKAGE_NAME</code>:Android包名</li>
<li><code>KEY_NOTIFY_ON_FAILURE</code>:授权失败时是否提示，boolean值</li>
<li><code>ACTION_AUTHENTICATOR_INTENT</code>:<code>android.accounts.AccountAuthenticator</code></li>
<li><code>AUTHENTICATOR_META_DATA_NAME</code>:<code>android.accounts.AccountAuthenticator</code></li>
<li><code>AUTHENTICATOR_ATTRIBUTES_NAME</code>:授权者的name属性</li>
</ul>
<h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><pre><code>public AccountManager(Context context, IAccountManager service) {
   mContext = context;
   mService = service;
   mMainHandler = new Handler(mContext.getMainLooper());
}
</code></pre><p>不会用到，获取一个账户管理者的实例，使用如下方法即可：</p>
<pre><code>public static AccountManager get(Context context) {
       if (context == null) throw new IllegalArgumentException(&quot;context is null&quot;);
       return (AccountManager) context.getSystemService(Context.ACCOUNT_SERVICE);
   }
</code></pre><h4 id="类结构"><a href="#类结构" class="headerlink" title="类结构"></a>类结构</h4><p><code>public class AccountManager{ ... }</code></p>
<p>public的类，没有实现任何接口。</p>
<h5 id="内部类-AmsTask"><a href="#内部类-AmsTask" class="headerlink" title="内部类-AmsTask"></a>内部类-AmsTask</h5><p><code>private abstract class AmsTask extends FutureTask&lt;Bundle&gt; implements AccountManagerFuture&lt;Bundle&gt; { ... }</code></p>
<p>看类修饰符：</p>
<ul>
<li>abstract ： 说明该类是一个模板类，必定有抽象方法，需要被子类化，实现具体的操作，</li>
<li>private：子类化应该是在外部类中<br>符合Java编码原则：使用函数对象代替策略。使类和成员的可访问性最小化。</li>
</ul>
<p>该类继承自一个可取消的异步计算，实现了一个处理计算结果的回调。</p>
<p>发现<code>AccountManagerFuture</code> 和<code>Future</code>两个接口的行为是一样的，一个在<code>android.accounts</code>里，另一个在<code>java.util.concurrent</code>.</p>
<p>AmsTask的构造方法为public，由于父类<code>FutureTask</code>的构造，必须要求传递<code>Callable</code>实例，如果没有这个实例，就会<code>NullPointerException</code>，所以直接在此截断抛出了。<br>因此，虽然传递了Callable，却禁止使用了，使用的还是Future。</p>
<pre><code>public AmsTask(Activity activity, Handler handler, AccountManagerCallback&lt;Bundle&gt; callback) {
      super(new Callable&lt;Bundle&gt;() {
          public Bundle call() throws Exception {
              throw new IllegalStateException(&quot;this should never be called&quot;);
          }
      });

      mHandler = handler;
      mCallback = callback;
      mActivity = activity;
      mResponse = new Response();
  }
</code></pre><ul>
<li>abstract void doWork()  由函数对象来具体实现操作</li>
<li>AccountManagerFuture<bundle> start() 开始执行<code>doWork()</code></bundle></li>
<li>void set(Bundle bundle) 父类方法，把结果设置给指定的Future，除非Future已经有结果或者已经被取消</li>
<li>Bundle getResult()、Bundle getResult(long timeout, TimeUnit unit)、Bundle internalGetResult(Long timeout, TimeUnit unit) 获取处理结果<blockquote>
<p>getResult最后都调用了<code>internalGetResult</code>方法。大概流程如下：</p>
<ul>
<li>判断线程是否执行结束</li>
<li>判断时间是否为null或已结束</li>
<li>获取结果</li>
<li>异常后取消线程执行</li>
</ul>
</blockquote>
</li>
</ul>
<p>确保当前线程不在主线程的代码：</p>
<pre><code>private void ensureNotOnMainThread() {
    final Looper looper = Looper.myLooper();
    if (looper != null &amp;&amp; looper == mContext.getMainLooper()) {
        final IllegalStateException exception = new IllegalStateException(
                &quot;calling this from your main thread can lead to deadlock&quot;);
        Log.e(TAG, &quot;calling this from your main thread can lead to deadlock and/or ANRs&quot;,
                exception);
        if (mContext.getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.FROYO) {
            throw exception;
        }
    }
}
</code></pre><p>跟踪到<code>FutureTask</code>的<code>get</code>方法里，这里返回父类的一个Object实例：<code>outcome</code>存放我们想要的结果对象。</p>
<p>在<code>get</code>里还有许多操作，比如判断线程执行的状态：</p>
<ul>
<li>NEW         </li>
<li>COMPLETING  </li>
<li>NORMAL      </li>
<li>EXCEPTIONAL </li>
<li>CANCELLED   </li>
<li>INTERRUPTING</li>
<li>INTERRUPTED </li>
</ul>
<p>我看到在操作线程状态的时候，使用了该类：<code>private static final sun.misc.Unsafe U = sun.misc.Unsafe.getUnsafe();</code>，用来保证原子操作，确定一个线程是<code>RUNNER</code>,<code>WAITER</code>.<br>这是一个JDK私有API，在Java9的时候可能移除，并使用<code>java.util.concurrent.LockSupport</code>实现。下面摘抄一段说明：</p>
<blockquote>
<p>原子访问是<code>sun.misc.Unsafe</code>被广泛应用的特性之一，特性包括简单的put、get操作(带有volatile语义或不带有volatile语义)以及比较并交换(compare and swap，CAS)操作。</p>
</blockquote>
<h5 id="AmsTask的内部类-Response"><a href="#AmsTask的内部类-Response" class="headerlink" title="AmsTask的内部类-Response"></a>AmsTask的内部类-Response</h5><p>AmsTask中有一个public的Response的引用。</p>
<p>操作一：<code>onResult</code></p>
<blockquote>
<p>响应有结果，跳转至用户提供的Activity，或是重试，再次调用<code>doWork()</code>，否则把响应数据bundle设置回父类的<code>outcome</code>里</p>
</blockquote>
<p>操作二：<code>onError</code></p>
<blockquote>
<p>取消线程的执行</p>
</blockquote>
<h5 id="内部类-BaseFutureTask"><a href="#内部类-BaseFutureTask" class="headerlink" title="内部类-BaseFutureTask"></a>内部类-BaseFutureTask</h5><p>可以看到这是一个抽象类，我们只要知道什么是需要子类实现的，什么是已经实现的。</p>
<pre><code>protected void postRunnableToHandler(Runnable runnable) {
       Handler handler = (mHandler == null) ? mMainHandler : mHandler;
       handler.post(runnable);
   }
</code></pre><p>把Runnable加入消息队列，可以当前线程的handler执行。</p>
<p><code>abstract void doWork()</code>  由函数对象来具体实现操作<br><code>abstract T bundleToResult(Bundle bundle)</code> 由函数对象来具体实现操作</p>
<h5 id="BaseFutureTask的内部类-Response"><a href="#BaseFutureTask的内部类-Response" class="headerlink" title="BaseFutureTask的内部类-Response"></a>BaseFutureTask的内部类-Response</h5><ul>
<li>onResult 调用外部类的<code>bundleToResult</code></li>
<li>onError 中断线程，抛出异常</li>
</ul>
<h5 id="内部类-Future2Task"><a href="#内部类-Future2Task" class="headerlink" title="内部类-Future2Task"></a>内部类-Future2Task</h5><ul>
<li>BaseFutureTask的子类，同时也是个抽象类，实现了<code>internalGetResult</code>，具体的贱<code>AmsTask$internalGetResult</code></li>
</ul>
<h5 id="内部类-GetAuthTokenByTypeAndFeaturesTask"><a href="#内部类-GetAuthTokenByTypeAndFeaturesTask" class="headerlink" title="内部类-GetAuthTokenByTypeAndFeaturesTask"></a>内部类-GetAuthTokenByTypeAndFeaturesTask</h5><p><code>AmsTask</code>的子类，顾名思义，根据类型和特征获取授权令牌的任务。</p>
<p><code>doWork()</code>的作用：</p>
<ul>
<li>根据类型和特征尝试获取已授权账户</li>
<li>未获取到账户，如果提示添加账户的activity为空，则把<code>KEY_ACCOUNT_NAME</code>,<code>KEY_ACCOUNT_TYPE</code>,<code>KEY_AUTHTOKEN</code>置为空，并返回</li>
<li>未获取到账户，如果提示添加账户的activity不为空，调用<code>addAccount</code>方法，这是一个Future，可以中断和等待结果的子线程</li>
<li>如果只获取到一个账户，获取AuthToken，放入响应</li>
<li>如果获取到了多个账户，启动<code>android.accounts.ChooseAccountActivity</code>,选择一个后，获取AuthToken，放入响应</li>
</ul>
<h4 id="主要方法"><a href="#主要方法" class="headerlink" title="主要方法"></a>主要方法</h4><h5 id="sanitizeResult"><a href="#sanitizeResult" class="headerlink" title="sanitizeResult"></a>sanitizeResult</h5><pre><code>public static Bundle sanitizeResult(Bundle result) {
      if (result != null) {
          if (result.containsKey(KEY_AUTHTOKEN)
                  &amp;&amp; !TextUtils.isEmpty(result.getString(KEY_AUTHTOKEN))) {
              final Bundle newResult = new Bundle(result);
              newResult.putString(KEY_AUTHTOKEN, &quot;&lt;omitted for logging purposes&gt;&quot;);
              return newResult;
          }
      }
      return result;
  }
</code></pre><p>如果返回的结果bundle中包含<code>KEY_AUTHTOKEN</code>，就把这个值变成“为了日志的目的而省略”，是对结果做一次“消毒”</p>
<h5 id="IAccountManager相关"><a href="#IAccountManager相关" class="headerlink" title="IAccountManager相关"></a>IAccountManager相关</h5><ul>
<li>getPassword</li>
<li>setPassword</li>
<li>clearPassword</li>
<li>getUserData</li>
<li>setUserData</li>
<li>getAuthenticatorTypes：此处返回一个数组，一个账户可以有多重类型，不需要权限</li>
<li>getAuthenticatorTypesAsUser：需要权限，或者相同的用户</li>
<li>getAccounts：需要权限</li>
<li>getAccountsAsUser</li>
<li>getAccountsForPackage：调用者可用的账户列表</li>
<li>updateAppPermission：仅被系统页面调用，不包含于SDK中</li>
<li>getAuthTokenLabel：获取与认证者相关联的用户友好标签，返回一个Future</li>
<li>hasFeatures：需要权限，指定的账户是拥有指定的权限。可用在任意线程，但返回结果不可用于主线程。</li>
<li>getAccountsByTypeAndFeatures：需要权限，根据类型和功能获取账户列表</li>
<li>addAccount</li>
<li>addSharedAccount</li>
<li>addAccountExplicitly：直接添加一个账户。这个方法不会刷新最近一次的时间戳，需要主动<code>notifyAccountAuthenticated</code>。但是，如果该方法触发了<code>addAccount()</code>或者<code>addAccountAsUser</code>，就不需要刷新时间戳，可以自动刷新了。可在主线程调用此方法。需要API22以上。</li>
<li>notifyAccountAuthenticated：通知系统账户刚刚被授权。可被其他程序用来验证账户。只有在授权成功方可调用。主线程不安全的。</li>
<li>renameAccount：先移除已有的账户，再添加重命名后的账户。</li>
<li>getPreviousName：获取改名前的名字，可能返回null，主线程安全的。</li>
<li>removeAccount：如果有，就从AccountManager删除账户，不会从服务器上删除。API22之前调用需要权限。</li>
<li>removeAccountAsUser</li>
<li>invalidateAuthToken：从AccountManager的缓存中移除授权。API22之前需要权限。</li>
<li>peekAuthToken：从缓存中取授权令牌，如果没有，生成一个新的，不会链接服务器。</li>
<li>setAuthToken</li>
<li>getAuthToken</li>
<li>getAuthTokenByFeatures</li>
<li>blockingGetAuthToken：会阻塞，不要在主线程调用，API22之前需要权限</li>
<li>copyAccountToUser</li>
<li>confirmCredentialsAsUser：</li>
<li>updateCredentials</li>
<li>editProperties：提供一个用户修改授权设置的机会。</li>
<li>ensureNotOnMainThread：确保不在主线程</li>
<li>postToHandler</li>
<li>convertErrorToException</li>
<li>newChooseAccountIntent：提供给用户一个可选账户的列表</li>
</ul>
<h4 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h4><p><a href="https://github.com/xusx1024/AccountManagerDemo" target="_blank" rel="external">AccountManagerDemo</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/14/android-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/14/android-notes/" itemprop="url">android - 消除非受检的警告</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-14T00:00:00Z">
                2017-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="using-setjavascriptenabled-can-introduce-xss-vulnerabilities-into-your-application"><a href="#using-setjavascriptenabled-can-introduce-xss-vulnerabilities-into-your-application" class="headerlink" title="using setjavascriptenabled can introduce xss vulnerabilities into your application"></a>using setjavascriptenabled can introduce xss vulnerabilities into your application</h4><p>在WebView中，如果你启用js，kotlin代码如下：</p>
<pre><code>webview.settings.javaScriptEnabled = true
</code></pre><p>会得到题目的警告提示。</p>
<p>原因是：启用js可能不安全，如果你真的需要，好好检查这些js。<br>消除：</p>
<pre><code>@SuppressLint(&quot;SetJavaScriptEnabled&quot;)
</code></pre><h4 id="WebView-addJavascriptInterface-should-not-be-called-with-minSdkVersion-lt-17-for-security-reasons-JavaScript-can-use-reflection-to-manipulate-application"><a href="#WebView-addJavascriptInterface-should-not-be-called-with-minSdkVersion-lt-17-for-security-reasons-JavaScript-can-use-reflection-to-manipulate-application" class="headerlink" title="WebView.addJavascriptInterface should not be called with minSdkVersion &lt; 17 for security reasons: JavaScript can use reflection to manipulate application"></a><code>WebView.addJavascriptInterface</code> should not be called with minSdkVersion &lt; 17 for security reasons: JavaScript can use reflection to manipulate application</h4><p>在WebView中，如果添加JS调用Java代码，kotlin代码如下：</p>
<pre><code>webview.addJavascriptInterface(JsObject(), &quot;onClick&quot;)
</code></pre><p>会得到题目的警告提示。</p>
<p>原因题目说的很清楚，“JavaScript可以通过反射操作应用”</p>
<p>官方的说明：<a href="https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29" target="_blank" rel="external">JavaScript安全不</a></p>
<p>一篇不错的<a href="http://blog.csdn.net/leehong2005/article/details/11808557" target="_blank" rel="external">blog</a></p>
<p>可以确定的是4.2，也就是17，JELLY BEAN之前，可以获取到SD读写权限，然后操作你的联系人、短信、etc</p>
<p>这个问题相当的经典。一般的应用估计都不会修复它。但如果应用用户太大，不得不修复。</p>
<h4 id="加载JS的时机"><a href="#加载JS的时机" class="headerlink" title="加载JS的时机"></a>加载JS的时机</h4><p>引申问题，你有一段JS，何时加载？</p>
<ul>
<li>onLoadResource</li>
<li>doUpdateVisitedHistory</li>
<li>onPageStarted</li>
<li>onPageFinished</li>
<li>onReceivedTitle</li>
<li>onProgressChanged</li>
</ul>
<h4 id="setRenderPriority-android-webkit-WebSettings-RenderPriority-’-is-deprecated"><a href="#setRenderPriority-android-webkit-WebSettings-RenderPriority-’-is-deprecated" class="headerlink" title="setRenderPriority(android.webkit.WebSettings.RenderPriority)’ is deprecated"></a>setRenderPriority(android.webkit.WebSettings.RenderPriority)’ is deprecated</h4><p>源码中：</p>
<blockquote>
<p>It is not recommended to adjust thread priorities, and this will not be supported in future versions.</p>
</blockquote>
<h4 id="webView-加载缓慢"><a href="#webView-加载缓慢" class="headerlink" title="webView 加载缓慢"></a>webView 加载缓慢</h4><pre><code>if (Build.VERSION.SDK_INT &gt;= 19) {//4.4，KK
           mWebView.setLayerType(View.LAYER_TYPE_HARDWARE, null);
       }
       else {
           mWebView.setLayerType(View.LAYER_TYPE_SOFTWARE, null);
       }
</code></pre><h4 id="This-Handler-class-should-be-static-or-leaks-might-occur-anonymous-android-os-Handler"><a href="#This-Handler-class-should-be-static-or-leaks-might-occur-anonymous-android-os-Handler" class="headerlink" title="This Handler class should be static or leaks might occur (anonymous android.os.Handler)"></a>This Handler class should be static or leaks might occur (anonymous android.os.Handler)</h4><p>我们在使用Handler发送消息时，往往使用内部类来实现Handler，这样可能导致内存泄露。</p>
<p>原因：</p>
<p>handler实例做为一个嵌套类，确切的说是做为一个内部类时，默认持有外部类的引用，</p>
<p>假设外部类为<code>SampleActivity</code>，并且Handler里有延时执行的任务，并且Activity提前finish</p>
<p>这样，由于activity的引用还在Handler的延时任务里，GC判定，该Activity虽然finish，但是不可回收，此时就发生了内存泄露</p>
<p>解决：</p>
<p>Handler使用静态内部类</p>
<p>Handler类中使用弱引用维护对activity的引用：</p>
<pre><code>private static class MyHandler extends Handler {
    private final WeakReference&lt;SampleActivity&gt; mActivity;

    public MyHandler(SampleActivity activity) {
      mActivity = new WeakReference&lt;SampleActivity&gt;(activity);
    }

    @Override
    public void handleMessage(Message msg) {
      SampleActivity activity = mActivity.get();
      if (activity != null) {
        // ...
      }
    }
  }

  private final MyHandler mHandler = new MyHandler(this);
</code></pre><p><a href="http://www.androiddesignpatterns.com/2013/01/inner-class-handler-memory-leak.html" target="_blank" rel="external">E文传送</a><br><a href="http://www.jianshu.com/p/1b39416f1508" target="_blank" rel="external">译文传送</a></p>
<h4 id="Warning-168-72-Unchecked-assignment-‘java-util-List’-to-‘java-util-List‘-Reason-‘queries’-has-raw-type-so-result-of-list-is-erased"><a href="#Warning-168-72-Unchecked-assignment-‘java-util-List’-to-‘java-util-List‘-Reason-‘queries’-has-raw-type-so-result-of-list-is-erased" class="headerlink" title="Warning:(168, 72) Unchecked assignment: ‘java.util.List’ to ‘java.util.List‘. Reason: ‘queries’ has raw type, so result of list is erased"></a>Warning:(168, 72) Unchecked assignment: ‘java.util.List’ to ‘java.util.List<com.xxx.greendao.xxbean>‘. Reason: ‘queries’ has raw type, so result of list is erased</com.xxx.greendao.xxbean></h4><p>只能添加指定类型，不会有警告：</p>
<pre><code>ArrayList&lt;String&gt; arr = new ArrayList&lt;String&gt;();
</code></pre><p>如果添加了String之外的类型，会有编译时警告：</p>
<pre><code>ArrayList&lt;String&gt; arr = new ArrayList();
</code></pre><p>这就是raw type，可以添加Object类型的对象，此时会提示<code>Unchecked assignment...</code>，</p>
<pre><code>ArrayList arr = new ArrayList&lt;String&gt;();
</code></pre><p>考察如下DEMO，可以编译通过，但是运行异常：</p>
<pre><code>import java.util.ArrayList;

public class TestRawType {

    public static void main(String[] args) {
          ArrayList arr = new ArrayList&lt;String&gt;();

          arr.add(&quot;qwer&quot;);
          arr.add(1234);
          arr.add(new Integer(2));

          System.out.println(arr.toString());

          for(Object o : arr){
              System.out.println((String)o);
          }
    }

}
</code></pre><blockquote>
<p>控制台输出：[qwer, 1234, 2]<br>qwer<br>Exception in thread “main” java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String<br>    at TestRawType.main(TestRawType.java:17)</p>
</blockquote>
<p>更加详细的解释，参考《effective java》 2nd 第23条：请不要在新代码中使用原生态类型</p>
<h4 id="Static-member-‘android-support-v4-app-FragmentActivity-RESULT-OK’-accessed-via-instance-reference"><a href="#Static-member-‘android-support-v4-app-FragmentActivity-RESULT-OK’-accessed-via-instance-reference" class="headerlink" title="Static member ‘android.support.v4.app.FragmentActivity.RESULT_OK’ accessed via instance reference"></a>Static member ‘android.support.v4.app.FragmentActivity.RESULT_OK’ accessed via instance reference</h4><p>原因：通过实例引用了某个类的静态变量，如下：</p>
<pre><code>getActivity().RESULT_OK
</code></pre><p>修改：</p>
<pre><code>Activity.RESULT_OK;
</code></pre><p><code>update @ 2017年7月14日18:50:52</code></p>
<h4 id="Dangling-Javadoc-comment"><a href="#Dangling-Javadoc-comment" class="headerlink" title="Dangling Javadoc comment"></a>Dangling Javadoc comment</h4><p>原因：悬空的注释（在你导出文档时，可能会丢失）</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/05/net-work-day03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XuShengSing">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="行次">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/05/net-work-day03/" itemprop="url">《图解HTTP》第5、6、7章</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-05T00:00:00Z">
                2017-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NetWork/" itemprop="url" rel="index">
                    <span itemprop="name">NetWork</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><ul>
<li>接收客户端请求，转发至源服务器</li>
<li>缓存请求，减少网络带宽流量</li>
<li>过滤请求</li>
<li>访问日志记录</li>
<li>多级代理，每通过一级会添加via首部，即可追踪报文的转发，还可避免请求回环的发生，经常和TRACE方法一起使用</li>
<li>透明/非透明代理：是否对报文内容进行加工</li>
</ul>
<h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><ul>
<li>利用网关可以由HTTP请求转化为其他协议通信</li>
<li>网关和代理的工作机制十分相似，网关能使通信线路上的服务器提供非HTTP协议服务</li>
<li>利用网关能提高通信的安全性</li>
</ul>
<h4 id="隧道"><a href="#隧道" class="headerlink" title="隧道"></a>隧道</h4><ul>
<li>安全：可使用SSL等加密手段进行通信</li>
<li>透明：隧道不解析HTTP请求，请求保持原样中转给之后的服务器</li>
</ul>
<h4 id="资源的缓存"><a href="#资源的缓存" class="headerlink" title="资源的缓存"></a>资源的缓存</h4><ul>
<li>代理服务器缓存</li>
<li>客户端缓存</li>
<li>减少流量带宽</li>
<li>减少服务器压力</li>
<li>减少响应时间</li>
<li>确定缓存的有效期</li>
</ul>
<h4 id="HTTP-首部"><a href="#HTTP-首部" class="headerlink" title="HTTP 首部"></a>HTTP 首部</h4><ul>
<li>HTTP首部字段重复的情况：根据浏览器不同，结果可能并不一致，有些优先处理先出现的，有些处理后出现的字段</li>
<li>请求首部、响应首部、通用首部、内容首部具体字段</li>
</ul>
<h4 id="HTTP的缺点"><a href="#HTTP的缺点" class="headerlink" title="HTTP的缺点"></a>HTTP的缺点</h4><ul>
<li>明文通信可能会被窃听</li>
<li>不验证通信方的身份，可能遭遇伪装：使用SSL[Secure Socket Layer]认证</li>
<li>无法证明报文的完整性，有可能遭遇篡改：中间人攻击</li>
</ul>
<h4 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h4><ul>
<li>HTTP + 加密 + 认证 + 完整性保护 = HTTPS</li>
<li>HTTPS并非新协议，通常HTTP直接和TCP通信，当使用SSL时，则演变成先和SSL通信，再由SSL和TCP通信。HTTPS即身披SSL协议外壳的HTTP</li>
</ul>
<h4 id="用户身份认证"><a href="#用户身份认证" class="headerlink" title="用户身份认证"></a>用户身份认证</h4><ul>
<li>SSL认证 - 计算机</li>
<li>表单认证 - 用户</li>
</ul>
<h4 id="对Web应用的攻击"><a href="#对Web应用的攻击" class="headerlink" title="对Web应用的攻击"></a>对Web应用的攻击</h4><ul>
<li>主动攻击服务器：针对服务器上的资源，代表手法：SQL注入和OS命令注入</li>
<li>被动攻击服务器：诱使用户出发陷阱，窃取用户信息，代表手法：跨站脚本攻击、跨站点请求伪造<ul>
<li>可利用用户的身份攻击企业内部网络</li>
</ul>
</li>
</ul>
<h5 id="跨站脚本攻击"><a href="#跨站脚本攻击" class="headerlink" title="跨站脚本攻击"></a>跨站脚本攻击</h5><p>Cross-Site  Scripting,XSS :是指通过存在安全漏洞的Web网站注册用户的浏览器内运行非法的HTML标签或JavaScript进行的一种攻击。动态创建的HTML部分有可能隐藏着安全漏洞。</p>
<ul>
<li>输入框中增加窃取用户名、密码的script。</li>
<li>窃取用户的Cookie</li>
</ul>
<h5 id="SQL注入攻击"><a href="#SQL注入攻击" class="headerlink" title="SQL注入攻击"></a>SQL注入攻击</h5><p>SQL Injection：是指针对Web应用使用的数据库，通过运行非法的SQL而产生的攻击。<br>破坏SQL语句结构。</p>
<h5 id="OS命令注入攻击"><a href="#OS命令注入攻击" class="headerlink" title="OS命令注入攻击"></a>OS命令注入攻击</h5><p>OS命令注入攻击(OS Command Injection)是指通过Web应用，执行非法的操作系统命令达到攻击的目的。只要在能调用Shell函数的地方就有存在被攻击的风险。可从Web应用中通过Shell来调用操作系统命令，通过OS注入攻击可执行OS上安装着的各种程序。</p>
<h5 id="HTTP首部注入攻击"><a href="#HTTP首部注入攻击" class="headerlink" title="HTTP首部注入攻击"></a>HTTP首部注入攻击</h5><p>HTTP首部注入攻击(HTTP Header Injection)是指攻击者通过在响应首部字段内插入换行，添加任意响应首部或主体的一种攻击。属于被动攻击模式。</p>
<p>向首部主体内添加内容的攻击称为HTTP响应截断攻击。</p>
<ul>
<li>设置Cookie信息</li>
<li>重定向至指定URL</li>
<li>显示任意的主体</li>
</ul>
<h4 id="因设置或设计上的缺陷引发的安全漏洞"><a href="#因设置或设计上的缺陷引发的安全漏洞" class="headerlink" title="因设置或设计上的缺陷引发的安全漏洞"></a>因设置或设计上的缺陷引发的安全漏洞</h4><ul>
<li>强制浏览：浏览那些原本非自愿公开的文件</li>
<li>不正确的错误消息处理：Web应用的错误信息包含对攻击者有用的信息。Web应用不必在用户的浏览画面上展示详细的错误消息。对攻击者来说，详细的错误消息有可能给他们下一次攻击以提示。</li>
<li>开放重定向：对指定的任意URL作重定向跳转的功能，假如重定向到恶意的Web网站，那么用户就会被诱导至那个Web网站。</li>
</ul>
<h4 id="会话引发的安全漏洞"><a href="#会话引发的安全漏洞" class="headerlink" title="会话引发的安全漏洞"></a>会话引发的安全漏洞</h4><ul>
<li>会话劫持：攻击者通过某种手段拿到了用户的会话ID，并非法使用此会话ID伪装成用户，达到攻击的目的。</li>
<li>会话固定攻击：强制用户使用攻击者指定的会话ID，属于被动攻击。</li>
<li>跨站点请求伪造：攻击者通过设置好的陷阱，强制对已完成认证的用户进行非预期的个人信息或设定信息等某些状态更新，属于被动攻击。</li>
</ul>
<h4 id="其他安全漏洞"><a href="#其他安全漏洞" class="headerlink" title="其他安全漏洞"></a>其他安全漏洞</h4><ul>
<li>密码破解：密码试错[穷举法，字典攻击]、密码破解</li>
<li>点击劫持：界面伪装</li>
<li>dos攻击：让运行中的服务呈停止状态的攻击。<ul>
<li>集中利用访问请求[发送大量合法请求]造成资源过载，导致资源用尽，服务停止</li>
<li>通过攻击安全漏洞使服务停止</li>
</ul>
</li>
<li>后门程序250：开发设置的隐藏入口</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/favicon.jpg"
               alt="XuShengSing" />
          <p class="site-author-name" itemprop="name">XuShengSing</p>
           
              <p class="site-description motion-element" itemprop="description">博观而约取，厚积而薄发。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">87</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xusx1024" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XuShengSing</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<div class="theme-info">

  <div class="powered-by"></div>

<!-- <span class="post-count">博客共字</span> -->

</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

  

  <!-- 背景动画 -->
<script type="text/javascript" src="/js/src/particle.js"></script>

</body>
</html>
